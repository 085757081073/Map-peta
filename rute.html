<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mapbox Rute</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const from = urlParams.get("from")?.split(",");
  const to = urlParams.get("to")?.split(",");
  const token = urlParams.get("token");

  mapboxgl.accessToken = token;
  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v12",
    center: from.map(Number),
    zoom: 13
  });

  map.on("load", () => {
    fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${from[1]},${from[0]};${to[1]},${to[0]}?geometries=geojson&access_token=${token}`)
      .then((res) => res.json())
      .then((data) => {
        const route = data.routes[0];
        const geojson = {
          type: "Feature",
          geometry: route.geometry
        };

        map.addSource("route", {
          type: "geojson",
          data: geojson
        });

        map.addLayer({
          id: "route",
          type: "line",
          source: "route",
          layout: { "line-join": "round", "line-cap": "round" },
          paint: { "line-color": "#ff0000", "line-width": 5 }
        });

        // Tampilkan marker
        new mapboxgl.Marker({ color: "green" }).setLngLat([from[1], from[0]]).addTo(map);
        new mapboxgl.Marker({ color: "red" }).setLngLat([to[1], to[0]]).addTo(map);

        // Kirim data ke Kodular
        const output = {
          jarak: (route.distance / 1000).toFixed(2) + " km",
          durasi: Math.round(route.duration / 60) + " menit"
        };
        if (window.AppInventor) {
          window.AppInventor.setWebViewString(JSON.stringify(output));
        }
      });
  });
</script>
</body>
</html>
