<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Rute Mapbox Dinamis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  const accessToken = 'pk.eyJ1IjoiaXJvbmFqYWxhaCIsImEiOiJjbWJpMnZhbHcwMThsMmpxdG1pc2tyNnB6In0.H1kXdAXmoFCinLAuAWBbUA';

  const urlParams = new URLSearchParams(window.location.search);

  function getCoords(param) {
    const val = urlParams.get(param);
    if (!val) return null;
    const parts = val.split(',').map(Number);
    return parts.length === 2 ? [parts[1], parts[0]] : null; // [lat, lng]
  }

  const from = getCoords('from') || [1.5649439, 124.8745422];
  const to = getCoords('to') || [1.4870958, 124.8369521];
  const vehicle = urlParams.get('vehicle') || 'car';

  // Tentukan icon kendaraan
  const icons = {
    motor: 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png',
    car: 'https://cdn-icons-png.flaticon.com/128/12689/12689302.png',
    kurir: 'https://cdn-icons-png.flaticon.com/128/9561/9561688.png'
  };

  const iconUrl = icons[vehicle.toLowerCase()] || icons.car;

  const map = L.map('map');
  const bounds = L.latLngBounds(from, to);
  map.fitBounds(bounds, { padding: [50, 50] });

  L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}@2x?access_token=${accessToken}`, {
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18,
    attribution: '© Mapbox © OpenStreetMap',
  }).addTo(map);

  const vehicleIcon = L.icon({
    iconUrl: iconUrl,
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -35]
  });

  async function getRoute() {
    const coords = [from[1], from[0]].join(',') + ';' + [to[1], to[0]].join(',');
    const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&access_token=${accessToken}`;
    try {
      const response = await fetch(url);
      const data = await response.json();

      if (!data.routes || data.routes.length === 0) {
        alert('Rute tidak ditemukan');
        return;
      }

      const route = data.routes[0];
      const geojson = route.geometry;
      const distance = route.distance; // meter

      L.geoJSON(geojson, {
        style: { color: '#FF0000', weight: 5 }
      }).addTo(map);

      // Tampilkan marker awal dengan icon kendaraan
      L.marker(from, { icon: vehicleIcon }).addTo(map).bindPopup("Titik Awal").openPopup();

      // Hitung dan tampilkan jarak di marker tujuan
      const jarakStr = distance >= 1000 ? (distance / 1000).toFixed(2) + ' km' : Math.round(distance) + ' m';
      L.marker(to).addTo(map).bindPopup(`Tujuan<br>Jarak: ${jarakStr}`).openPopup();

    } catch (err) {
      console.error('Error saat ambil rute:', err);
      alert('Gagal mengambil data rute.');
    }
  }

  getRoute();
</script>
</body>
</html>
